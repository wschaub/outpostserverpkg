head	1.7;
access;
symbols;
locks
	wschaub:1.7; strict;
comment	@ * @;


1.7
date	2011.06.21.23.11.22;	author wschaub;	state Exp;
branches;
next	1.6;

1.6
date	2011.06.21.00.52.13;	author wschaub;	state Exp;
branches;
next	1.5;

1.5
date	2011.06.21.00.29.26;	author wschaub;	state Exp;
branches;
next	1.4;

1.4
date	2011.06.20.21.33.19;	author wschaub;	state Exp;
branches;
next	1.3;

1.3
date	2011.06.20.21.03.13;	author wschaub;	state Exp;
branches;
next	1.2;

1.2
date	2011.06.20.06.36.22;	author wschaub;	state Exp;
branches;
next	1.1;

1.1
date	2011.06.18.00.15.41;	author wschaub;	state Exp;
branches;
next	;


desc
@C program to use modbus to grab state information from the sunsaver smart charger.
@


1.7
log
@replace ASCII degree symbol with the HTML equiv of the same.
@
text
@//$Id: sunsaver.c,v 1.6 2011/06/21 00:52:13 wschaub Exp wschaub $
/*
 *  sunsaver.c - This program reads all the RAM registers on a Moringstar SunSaver MPPT and prints the results.
 *  

Copyright 2010 Tom Rinehart.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

/* Modified for Genesi by William Schaub <wschaub@@steubentech.com> */
/* Compile with: cc sunsaver.c -o sunsaver -lmodbus */

#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <modbus/modbus.h>

#define SUNSAVERMPPT    0x01	/* MODBUS Address of the SunSaver MPPT */
#define MAXSIZE 100 /* Not used right now */
#define INTERVAL 900 /* interval in seconds to poll the sunsaver for data */

/* Write out sunsaver state information to a text file every INTERVAL seconds */
int main(int argc, char **argv)
{
    FILE *fp;
    if(argc < 2 ) {
        fprintf(stderr,"you must specify a path to write to\n");
        exit(1);
    }


     while(1){
        fp = fopen(argv[1],"a");
        if(fp == NULL) {
            perror(argv[1]);
            exit(1);
        }
        write_log(fp);
        fflush(fp);
        fclose(fp);
        sleep(INTERVAL);
    }
} 

/* Open the serial device , grab the data off modbus and write a record to the log file */
int write_log(FILE *fp) 
{
    time_t timestamp;
	modbus_param_t mb_param;
	int ret;
	float adc_vb_f,adc_va_f,adc_vl_f,adc_ic_f,adc_il_f, Vb_f, Vb_ref, Ahc_r, Ahc_t, kWhc;
	float V_lvd, Ahl_r, Ahl_t, Power_out, Sweep_Vmp, Sweep_Pmax, Sweep_Voc, Vb_min_daily;
	float Vb_max_daily, Ahc_daily, Ahl_daily, vb_min, vb_max;
	short T_hs, T_batt, T_amb, T_rts;
	unsigned short charge_state, load_state, led_state;
	unsigned int hourmeter;
	unsigned short array_fault, load_fault, dip_switch, array_fault_daily, load_fault_daily;
	unsigned int alarm, alarm_daily;
	uint16_t data[50];
    char charge_state_text[100];
    char array_fault_text[100];
    char load_fault_text[100];
	
	/* Setup the serial port parameters */
	modbus_init_rtu(&mb_param, "/dev/ttyUSB0", 9600, "none", 8, 2);	/* Add the appropriate path to your serial port */
	
	/* Open the MODBUS connection */
	if (modbus_connect(&mb_param) == -1) {
		fprintf(stderr,"ERROR Connection failed\n");
		return(1);
	}
	
	/* Read the RAM Registers */
	ret = read_input_registers(&mb_param, SUNSAVERMPPT, 0x0008, 45, data);
    if(ret < 0 ) {
        fprintf(stderr,"ERROR Failed to read registers\n");
        return(1);
    }
	
	/* Close the MODBUS connection */
	modbus_close(&mb_param);
    
    timestamp = time(NULL);
    fprintf(fp,"%lu,",timestamp);//write timestamp field.
    fprintf(stderr,"%lu\n",timestamp);
	
	/* Convert the results to their proper values and print them out */
	//printf("RAM Registers\n\n");
	
	adc_vb_f=data[0]*100.0/32768.0;
	//printf("adc_vb_f = %.2f V\n",adc_vb_f);
	fprintf(fp,"%.2f V,",adc_vb_f);
	
	adc_va_f=data[1]*100.0/32768.0;
	//printf("adc_va_f = %.2f V\n",adc_va_f);
	fprintf(fp,"%.2f V,",adc_va_f);
	
	adc_vl_f=data[2]*100.0/32768.0;
	//printf("adc_vl_f = %.2f V\n",adc_vl_f);
	fprintf(fp,"%.2f V,",adc_vl_f);
	
	adc_ic_f=data[3]*79.16/32768.0;
	//printf("adc_ic_f = %.2f A\n",adc_ic_f);
	fprintf(fp,"%.2f A,",adc_ic_f);
	
	adc_il_f=data[4]*79.16/32768.0;
	//printf("adc_il_f = %.2f A\n",adc_il_f);
	fprintf(fp,"%.2f A,",adc_il_f);
	
	T_hs=data[5];
	//printf("T_hs = %d °C\n",T_hs);
	fprintf(fp,"%d &deg;C,",T_hs);
	
	T_batt=data[6];
	//printf("T_batt = %d °C\n",T_batt);
	fprintf(fp,"%d &deg;C,",T_batt);
	
	T_amb=data[7];
	//printf("T_amb = %d °C\n",T_amb);
	fprintf(fp,"%d &deg;C,",T_amb);
	
	T_rts=data[8];
	//printf("T_rts = %d °C\n",T_rts);
	fprintf(fp,"%d &deg;C,",T_rts);
	
	charge_state=data[9];
	switch (charge_state) {
		case 0:
			//printf("charge_state = %d START\n",charge_state);
			fprintf(fp,"%d START,",charge_state);
			break;
		case 1:
			//printf("charge_state = %d NIGHT_CHECK\n",charge_state);
			fprintf(fp,"%d NIGHT_CHECK,",charge_state);
			break;
		case 2:
			//printf("charge_state = %d DISCONNECT\n",charge_state);
			fprintf(fp,"%d DISCONNECT,",charge_state);
			break;
		case 3:
			//printf("charge_state = %d NIGHT\n",charge_state);
			fprintf(fp,"%d NIGHT,",charge_state);
			break;
		case 4:
			//printf("charge_state = %d FAULT\n",charge_state);
			fprintf(fp,"%d FAULT,",charge_state);
			break;
		case 5:
			//printf("charge_state = %d BULK_CHARGE\n",charge_state);
			fprintf(fp,"%d BULK_CHARGE,",charge_state);
			break;
		case 6:
			//printf("charge_state = %d ABSORPTION\n",charge_state);
			fprintf(fp,"%d ABSORPTION,",charge_state);
			break;
		case 7:
			//printf("charge_state = %d FLOAT\n",charge_state);
			fprintf(fp,"%d FLOAT,",charge_state);
			break;
		case 8:
			//printf("charge_state = %d EQUALIZE\n",charge_state);
			fprintf(fp,"%d EQUALIZE,",charge_state);
			break;
            fprintf(fp,",");
	}
	
	array_fault=data[10];
	//printf("array_fault = Solar input self-diagnostic faults:\n");
	if (array_fault == 0) {
		//printf("\tNo faults\n");
		fprintf(fp,"No faults,");
	} else {
		//if (array_fault & 1) printf("\tOvercurrent\n");
		if (array_fault & 1) fprintf(fp,"Overcurrent:");
		//if ((array_fault & (1 << 1)) >> 1) printf("\tFETs shorted\n");
		if ((array_fault & (1 << 1)) >> 1) fprintf(fp,"FETs shorted:");
		//if ((array_fault & (1 << 2)) >> 2) printf("\tSoftware bug\n");
		if ((array_fault & (1 << 2)) >> 2) fprintf(fp,"Software bug:");
		//if ((array_fault & (1 << 3)) >> 3) printf("\tBattery HVD\n");
		if ((array_fault & (1 << 3)) >> 3) fprintf(fp,"Battery HVD:");
		//if ((array_fault & (1 << 4)) >> 4) printf("\tArray HVD\n");
		if ((array_fault & (1 << 4)) >> 4) fprintf(fp,"Array HVD:");
		//if ((array_fault & (1 << 5)) >> 5) printf("\tEEPROM setting edit (reset required)\n");
		if ((array_fault & (1 << 5)) >> 5) fprintf(fp,"EEPROM setting edit (reset required):");
		//if ((array_fault & (1 << 6)) >> 6) printf("\tRTS shorted\n");
		if ((array_fault & (1 << 6)) >> 6) fprintf(fp,"RTS shorted:");
		//if ((array_fault & (1 << 7)) >> 7) printf("\tRTS was valid, now disconnected\n");
		if ((array_fault & (1 << 7)) >> 7) fprintf(fp,"RTS was valid, now disconnected:");
		//if ((array_fault & (1 << 8)) >> 8) printf("\tLocal temperature sensor failed\n");
		if ((array_fault & (1 << 8)) >> 8) fprintf(fp,"Local temperature sensor failed:");
		//if ((array_fault & (1 << 9)) >> 9) printf("\tFault 10\n");
		if ((array_fault & (1 << 9)) >> 9) fprintf(fp,"Fault 10:");
		//if ((array_fault & (1 << 10)) >> 10) printf("\tFault 11\n");
		if ((array_fault & (1 << 10)) >> 10) fprintf(fp,"Fault 11:");
		//if ((array_fault & (1 << 11)) >> 11) printf("\tFault 12\n");
		if ((array_fault & (1 << 11)) >> 11) fprintf(fp,"Fault 12:");
		//if ((array_fault & (1 << 12)) >> 12) printf("\tFault 13\n");
		if ((array_fault & (1 << 12)) >> 12) fprintf(fp,"Fault 13:");
		//if ((array_fault & (1 << 13)) >> 13) printf("\tFault 14\n");
		if ((array_fault & (1 << 13)) >> 13) fprintf(fp,"Fault 14:");
		//if ((array_fault & (1 << 14)) >> 14) printf("\tFault 15\n");
		if ((array_fault & (1 << 14)) >> 14) fprintf(fp,"Fault 15:");
		//if ((array_fault & (1 << 15)) >> 15) printf("\tFault 16\n");
		if ((array_fault & (1 << 15)) >> 15) fprintf(fp,"Fault 16");
        fprintf(fp,",");
	}
	
	Vb_f=data[11]*100.0/32768.0;
	//printf("Vb_f = %.2f V\n",Vb_f);
	fprintf(fp,"%.2f V,",Vb_f);
	
	Vb_ref=data[12]*96.667/32768.0;
	//printf("Vb_ref = %.2f V\n",Vb_ref);
	fprintf(fp,"%.2f V,",Vb_ref);
	
	Ahc_r=((data[13] << 16) + data[14])*0.1;
	//printf("Ahc_r = %.2f Ah\n",Ahc_r);
	fprintf(fp,"%.2f Ah,",Ahc_r);
	
	Ahc_t=((data[15] << 16) + data[16])*0.1;
	//printf("Ahc_t = %.2f Ah\n",Ahc_t);
	fprintf(fp,"%.2f Ah,",Ahc_t);
	
	kWhc=data[17]*0.1;
	//printf("kWhc = %.2f kWh\n",kWhc);
	fprintf(fp,"%.2f kWh,",kWhc);
	
	load_state=data[18];
	switch (load_state) {
		case 0:
			//printf("load_state = %d START\n",load_state);
			fprintf(fp,"%d START,",load_state);
			break;
		case 1:
			//printf("load_state = %d LOAD_ON\n",load_state);
			fprintf(fp,"%d LOAD_ON,",load_state);
			break;
		case 2:
			//printf("load_state = %d LVD_WARNING\n",load_state);
			fprintf(fp,"%d LVD_WARNING,",load_state);
			break;
		case 3:
			//printf("load_state = %d LVD\n",load_state);
			fprintf(fp,"%d LVD,",load_state);
			break;
		case 4:
			//printf("load_state = %d FAULT\n",load_state);
			fprintf(fp,"%d FAULT,",load_state);
			break;
		case 5:
			//printf("load_state = %d DISCONNECT\n",load_state);
			fprintf(fp,"%d DISCONNECT,",load_state);
			break;
	}
	
	load_fault=data[19];
	//printf("load_fault = Load output self-diagnostic faults:\n");
	if (load_fault == 0) {
		//printf("\tNo faults\n");
		fprintf(fp,"No faults,");
	} else {
		//if (load_fault & 1) printf("\tExternal short circuit\n");
		if (load_fault & 1) fprintf(fp,"External short circuit:");
		//if ((load_fault & (1 << 1)) >> 1) printf("\tOvercurrent\n");
		if ((load_fault & (1 << 1)) >> 1) fprintf(fp,"Overcurrent:");
		//if ((load_fault & (1 << 2)) >> 2) printf("\tFETs shorted\n");
		if ((load_fault & (1 << 2)) >> 2) fprintf(fp,"FETs shorted:");
		//if ((load_fault & (1 << 3)) >> 3) printf("\tSoftware bug\n");
		if ((load_fault & (1 << 3)) >> 3) fprintf(fp,"Software bug:");
		//if ((load_fault & (1 << 4)) >> 4) printf("\tHVD\n");
		if ((load_fault & (1 << 4)) >> 4) fprintf(fp,"HVD:");
		//if ((load_fault & (1 << 5)) >> 5) printf("\tHeatsink over-temperature\n");
		if ((load_fault & (1 << 5)) >> 5) fprintf(fp,"Heatsink over-temperature:");
		//if ((load_fault & (1 << 6)) >> 6) printf("\tEEPROM setting edit (reset required)\n");
		if ((load_fault & (1 << 6)) >> 6) fprintf(fp,"EEPROM setting edit (reset required):");
		//if ((load_fault & (1 << 7)) >> 7) printf("\tFault 8\n");
		if ((load_fault & (1 << 7)) >> 7) fprintf(fp,"Fault 8");
        fprintf(fp,",");
	}
	
	V_lvd=data[20]*100.0/32768.0;
	//printf("V_lvd = %.2f V\n",V_lvd);
	fprintf(fp,"%.2f V,",V_lvd);
	
	Ahl_r=((data[21] << 16) + data[22])*0.1;
	//printf("Ahl_r = %.2f Ah\n",Ahl_r);
	fprintf(fp,"%.2f Ah,",Ahl_r);
	
	Ahl_t=((data[23] << 16) + data[24])*0.1;
	//printf("Ahl_t = %.2f Ah\n",Ahl_t);
	fprintf(fp,"%.2f Ah,",Ahl_t);
	
	hourmeter=(data[25] << 16) + data[26];
	//printf("hourmeter = %d h\n",hourmeter);
	fprintf(fp,"%d h,",hourmeter);
	
	alarm=(data[27] << 16) + data[28];
	//printf("alarm = Controller self-diagnostic alarms:\n");
	if (alarm == 0) {
		//printf("\tNo alarms\n");
		fprintf(fp,"No alarms,");
	} else {
		//if (alarm & 1) printf("\tRTS open\n");
		if (alarm & 1) fprintf(fp,"RTS open:");
		//if ((alarm & (1 << 1)) >> 1) printf("\tRTS shorted\n");
		if ((alarm & (1 << 1)) >> 1) fprintf(fp,"RTS shorted:");
		//if ((alarm & (1 << 2)) >> 2) printf("\tRTS disconnected\n");
		if ((alarm & (1 << 2)) >> 2) fprintf(fp,"RTS disconnected:");
		//if ((alarm & (1 << 3)) >> 3) printf("\tThs open\n");
		if ((alarm & (1 << 3)) >> 3) fprintf(fp,"Ths open:");
		//if ((alarm & (1 << 4)) >> 4) printf("\tThs shorted\n");
		if ((alarm & (1 << 4)) >> 4) fprintf(fp,"Ths shorted:");
		//if ((alarm & (1 << 5)) >> 5) printf("\tSSMPPT hot\n");
		if ((alarm & (1 << 5)) >> 5) fprintf(fp,"SSMPPT hot:");
		//if ((alarm & (1 << 6)) >> 6) printf("\tCurrent limit\n");
		if ((alarm & (1 << 6)) >> 6) fprintf(fp,"Current limit:");
		//if ((alarm & (1 << 7)) >> 7) printf("\tCurrent offset\n");
		if ((alarm & (1 << 7)) >> 7) fprintf(fp,"Current offset:");
		//if ((alarm & (1 << 8)) >> 8) printf("\tUndefined\n");
		if ((alarm & (1 << 8)) >> 8) fprintf(fp,"8 Undefined:");
		//if ((alarm & (1 << 9)) >> 9) printf("\tUndefined\n");
		if ((alarm & (1 << 9)) >> 9) fprintf(fp,"9 Undefined:");
		//if ((alarm & (1 << 10)) >> 10) printf("\tUncalibrated\n");
		if ((alarm & (1 << 10)) >> 10) fprintf(fp,"Uncalibrated:");
		//if ((alarm & (1 << 11)) >> 11) printf("\tRTS miswire\n");
		if ((alarm & (1 << 11)) >> 11) fprintf(fp,"RTS miswire:");
		//if ((alarm & (1 << 12)) >> 12) printf("\tUndefined\n");
		if ((alarm & (1 << 12)) >> 12) fprintf(fp,"12 Undefined:");
		//if ((alarm & (1 << 13)) >> 13) printf("\tUndefined\n");
		if ((alarm & (1 << 13)) >> 13) fprintf(fp,"13 Undefined:");
		//if ((alarm & (1 << 14)) >> 14) printf("\tMiswire\n");
		if ((alarm & (1 << 14)) >> 14) fprintf(fp,"Miswire:");
		//if ((alarm & (1 << 15)) >> 15) printf("\tFET open\n");
		if ((alarm & (1 << 15)) >> 15) fprintf(fp,"FET open:");
		//if ((alarm & (1 << 16)) >> 16) printf("\tP12\n");
		if ((alarm & (1 << 16)) >> 16) fprintf(fp,"P12:");
		//if ((alarm & (1 << 17)) >> 17) printf("\tHigh Va current limit\n");
		if ((alarm & (1 << 17)) >> 17) fprintf(fp,"High Va current limit:");
		//if ((alarm & (1 << 18)) >> 18) printf("\tAlarm 19\n");
		if ((alarm & (1 << 18)) >> 18) fprintf(fp,"Alarm 19:");
		//if ((alarm & (1 << 19)) >> 19) printf("\tAlarm 20\n");
		if ((alarm & (1 << 19)) >> 19) fprintf(fp,"Alarm 20:");
		//if ((alarm & (1 << 20)) >> 20) printf("\tAlarm 21\n");
		if ((alarm & (1 << 20)) >> 20) fprintf(fp,"Alarm 21:");
		//if ((alarm & (1 << 21)) >> 21) printf("\tAlarm 22\n");
		if ((alarm & (1 << 21)) >> 21) fprintf(fp,"Alarm 22:");
		//if ((alarm & (1 << 22)) >> 22) printf("\tAlarm 23\n");
		if ((alarm & (1 << 22)) >> 22) fprintf(fp,"Alarm 23:");
		//if ((alarm & (1 << 23)) >> 23) printf("\tAlarm 24\n");
		if ((alarm & (1 << 23)) >> 23) fprintf(fp,"Alarm 24");
        fprintf(fp,",");
	}
	
	dip_switch=data[29];
	//printf("dip_switch = DIP switch settings:\n");
	if (dip_switch & 1) {
		//printf("\tSwitch 1 ON - Battery Type: Gel or AGM\n");
		fprintf(fp,"Switch 1 ON - Battery Type: Gel or AGM,");
	} else {
		//printf("\tSwitch 1 OFF - Battery Type: Sealed or Flooded\n");
		fprintf(fp,"Switch 1 OFF - Battery Type: Sealed or Flooded,");
	}
	if ((dip_switch & (1 << 1)) >> 1) {
		//printf("\tSwitch 2 ON - LVD = 11.00 V, LVR = 12.10 V or custom load settings\n");
		fprintf(fp,"Switch 2 ON - LVD = 11.00 V LVR = 12.10 V or custom load settings,");
	} else {
		//printf("\tSwitch 2 OFF - LVD = 11.50 V, LVR = 12.60 V\n");
		fprintf(fp,"Switch 2 OFF - LVD = 11.50 V LVR = 12.60 V,");
	}
	if ((dip_switch & (1 << 2)) >> 2) {
		//printf("\tSwitch 3 ON - Auto-Equalize On\n");
		fprintf(fp,"Switch 3 ON - Auto-Equalize On,");
	} else {
		//printf("\tSwitch 3 OFF - Auto-Equalize Off\n");
		printf("Switch 3 OFF - Auto-Equalize Off,");
	}
	if ((dip_switch & (1 << 3)) >> 3) {
		//printf("\tSwitch 4 ON - MODBUS Protocol\n");
		fprintf(fp,"Switch 4 ON - MODBUS Protocol,");
	} else {
		//printf("\tSwitch 4 OFF - Meterbus Protocol\n");
		fprintf(fp,"Switch 4 OFF - Meterbus Protocol,");
	}
	
	led_state=data[30];
	switch (led_state) {
		case 0:
			//printf("led_state = %d LED_START\n",led_state);
			fprintf(fp,"%d LED_START,",led_state);
			break;
		case 1:
			//printf("led_state = %d LED_START2\n",led_state);
			fprintf(fp,"%d LED_START2,",led_state);
			break;
		case 2:
			//printf("led_state = %d LED_BRANCH\n",led_state);
			fprintf(fp,"%d LED_BRANCH,",led_state);
			break;
		case 3:
			//printf("led_state = %d EQUALIZE (FAST GREEN BLINK)\n",led_state);
			fprintf(fp,"%d EQUALIZE (FAST GREEN BLINK),",led_state);
			break;
		case 4:
			//printf("led_state = %d FLOAT (SLOW GREEN BLINK)\n",led_state);
			fprintf(fp,"%d FLOAT (SLOW GREEN BLINK),",led_state);
			break;
		case 5:
			//printf("led_state = %d ABSORPTION (GREEN BLINK, 1HZ)\n",led_state);
			fprintf(fp,"led_state = %d ABSORPTION (GREEN BLINK 1HZ),",led_state);
			break;
		case 6:
			//printf("led_state = %d GREEN_LED\n",led_state);
			fprintf(fp,"%d GREEN_LED,",led_state);
			break;
		case 7:
			//printf("led_state = %d UNDEFINED\n",led_state);
			fprintf(fp,"%d UNDEFINED,",led_state);
			break;
		case 8:
			//printf("led_state = %d YELLOW_LED\n",led_state);
			fprintf(fp,"%d YELLOW_LED,",led_state);
			break;
		case 9:
			fprintf(fp,"%d UNDEFINED,",led_state);
			break;
		case 10:
			//printf("led_state = %d BLINK_RED_LED\n",led_state);
			fprintf(fp,"%d BLINK_RED_LED,",led_state);
			break;
		case 11:
			//printf("led_state = %d RED_LED\n",led_state);
			fprintf(fp,"%d RED_LED,",led_state);
			break;
		case 12:
			//printf("led_state = %d R-Y-G ERROR\n",led_state);
			fprintf(fp,"%d R-Y-G ERROR,",led_state);
			break;
		case 13:
			//printf("led_state = %d R/Y-G ERROR\n",led_state);
			fprintf(fp,"%d R/Y-G ERROR,",led_state);
			break;
		case 14:
			//printf("led_state = %d R/G-Y ERROR\n",led_state);
			fprintf(fp,"led_state = %d R/G-Y ERROR,",led_state);
			break;
		case 15:
			//printf("led_state = %d R-Y ERROR (HTD)\n",led_state);
			fprintf(fp,"%d R-Y ERROR (HTD),",led_state);
			break;
		case 16:
			//printf("led_state = %d R-G ERROR (HVD)\n",led_state);
			fprintf(fp,"%d R-G ERROR (HVD),",led_state);
			break;
		case 17:
			//printf("led_state = %d R/Y-G/Y ERROR\n",led_state);
			fprintf(fp,"%d R/Y-G/Y ERROR,",led_state);
			break;
		case 18:
			//printf("led_state = %d G/Y/R ERROR\n",led_state);
			fprintf(fp,"%d G/Y/R ERROR,",led_state);
			break;
		case 19:
			//printf("led_state = %d G/Y/R x 2\n",led_state);
			fprintf(fp,"led_state = %d G/Y/R x 2,",led_state);
			break;
	}
	
	Power_out=data[31]*989.5/65536.0;
	//printf("Power_out = %.2f W\n",Power_out);
	fprintf(fp,"%.2f W,",Power_out);
	
	Sweep_Vmp=data[32]*100.0/32768.0;
	//printf("Sweep_Vmp = %.2f V\n",Sweep_Vmp);
	fprintf(fp,"%.2f V,",Sweep_Vmp);
	
	Sweep_Pmax=data[33]*989.5/65536.0;
	//printf("Sweep_Pmax = %.2f W\n",Sweep_Pmax);
	fprintf(fp,"%.2f W,",Sweep_Pmax);
	
	Sweep_Voc=data[34]*100.0/32768.0;
	//printf("Sweep_Voc = %.2f V\n",Sweep_Voc);
	fprintf(fp,"%.2f V,",Sweep_Voc);
	
	Vb_min_daily=data[35]*100.0/32768.0;
	//printf("Vb_min_daily = %.2f V\n",Vb_min_daily);
	fprintf(fp,"%.2f V,",Vb_min_daily);
	
	Vb_max_daily=data[36]*100.0/32768.0;
	//printf("Vb_max_daily = %.2f V\n",Vb_max_daily);
	fprintf(fp,"%.2f V,",Vb_max_daily);
	
	Ahc_daily=data[37]*0.1;
	//printf("Ahc_daily = %.2f Ah\n",Ahc_daily);
	fprintf(fp,"%.2f Ah,",Ahc_daily);
	
	Ahl_daily=data[38]*0.1;
	//printf("Ahl_daily = %.2f Ah\n",Ahl_daily);
	fprintf(fp,"%.2f Ah,",Ahl_daily);
	
	array_fault_daily=data[39];
	//printf("array_fault_daily = Today's solar input self-diagnostic faults:\n");
	if (array_fault_daily == 0) {
		//printf("\tNo faults\n");
		fprintf(fp,"No faults,");
	} else {
		//if (array_fault_daily & 1) printf("\tOvercurrent\n");
		if (array_fault_daily & 1) fprintf(fp,"Overcurrent:");
		//if ((array_fault_daily & (1 << 1)) >> 1) printf("\tFETs shorted\n");
		if ((array_fault_daily & (1 << 1)) >> 1) fprintf(fp,"FETs shorted:");
		//if ((array_fault_daily & (1 << 2)) >> 2) printf("\tSoftware bug\n");
		if ((array_fault_daily & (1 << 2)) >> 2) fprintf(fp,"Software bug:");
		//if ((array_fault_daily & (1 << 3)) >> 3) printf("\tBattery HVD\n");
		if ((array_fault_daily & (1 << 3)) >> 3) fprintf(fp,"Battery HVD:");
		//if ((array_fault_daily & (1 << 4)) >> 4) printf("\tArray HVD\n");
		if ((array_fault_daily & (1 << 4)) >> 4) fprintf(fp,"Array HVD:");
		//if ((array_fault_daily & (1 << 5)) >> 5) printf("\tEEPROM setting edit (reset required)\n");
		if ((array_fault_daily & (1 << 5)) >> 5) fprintf(fp,"EEPROM setting edit (reset required):");
		//if ((array_fault_daily & (1 << 6)) >> 6) printf("\tRTS shorted\n");
		if ((array_fault_daily & (1 << 6)) >> 6) fprintf(fp,"RTS shorted:");
		//if ((array_fault_daily & (1 << 7)) >> 7) printf("\tRTS was valid, now disconnected\n");
		if ((array_fault_daily & (1 << 7)) >> 7) fprintf(fp,"RTS was valid, now disconnected:");
		//if ((array_fault_daily & (1 << 8)) >> 8) printf("\tLocal temperature sensor failed\n");
		if ((array_fault_daily & (1 << 8)) >> 8) fprintf(fp,"Local temperature sensor failed:");
		//if ((array_fault_daily & (1 << 9)) >> 9) printf("\tFault 10\n");
		if ((array_fault_daily & (1 << 9)) >> 9) fprintf(fp,"Fault 10:");
		//if ((array_fault_daily & (1 << 10)) >> 10) printf("\tFault 11\n");
		if ((array_fault_daily & (1 << 10)) >> 10) fprintf(fp,"Fault 11:");
		//if ((array_fault_daily & (1 << 11)) >> 11) printf("\tFault 12\n");
		if ((array_fault_daily & (1 << 11)) >> 11) fprintf(fp,"Fault 12:");
		//if ((array_fault_daily & (1 << 12)) >> 12) printf("\tFault 13\n");
		if ((array_fault_daily & (1 << 12)) >> 12) fprintf(fp,"Fault 13:");
		//if ((array_fault_daily & (1 << 13)) >> 13) printf("\tFault 14\n");
		if ((array_fault_daily & (1 << 13)) >> 13) fprintf(fp,"\tFault 14\n");
		//if ((array_fault_daily & (1 << 14)) >> 14) printf("\tFault 15\n");
		if ((array_fault_daily & (1 << 14)) >> 14) fprintf(fp,"Fault 15:");
		//if ((array_fault_daily & (1 << 15)) >> 15) printf("\tFault 16\n");
		if ((array_fault_daily & (1 << 15)) >> 15) fprintf(fp,"\tFault 16");
        fprintf(fp,",");
	}
	
	load_fault_daily=data[40];
	//printf("load_fault_daily = Today's load output self-diagnostic faults:\n");
	if (load_fault_daily == 0) {
		//printf("\tNo faults\n");
		fprintf(fp,"No faults,");
	} else {
		//if (load_fault_daily & 1) printf("\tExternal short circuit\n");
		if (load_fault_daily & 1) fprintf(fp,"External short circuit:");
		//if ((load_fault_daily & (1 << 1)) >> 1) printf("\tOvercurrent\n");
		if ((load_fault_daily & (1 << 1)) >> 1) fprintf(fp,"Overcurrent:");
		//if ((load_fault_daily & (1 << 2)) >> 2) printf("\tFETs shorted\n");
		if ((load_fault_daily & (1 << 2)) >> 2) fprintf(fp,"FETs shorted:");
		//if ((load_fault_daily & (1 << 3)) >> 3) printf("\tSoftware bug\n");
		if ((load_fault_daily & (1 << 3)) >> 3) fprintf(fp,"Software bug:");
		//if ((load_fault_daily & (1 << 4)) >> 4) printf("\tHVD\n");
		if ((load_fault_daily & (1 << 4)) >> 4) fprintf(fp,"HVD:");
		//if ((load_fault_daily & (1 << 5)) >> 5) printf("\tHeatsink over-temperature\n");
		if ((load_fault_daily & (1 << 5)) >> 5) fprintf(fp,"Heatsink over-temperature:");
		//if ((load_fault_daily & (1 << 6)) >> 6) printf("\tEEPROM setting edit (reset required)\n");
		if ((load_fault_daily & (1 << 6)) >> 6) fprintf(fp,"EEPROM setting edit (reset required):");
		//if ((load_fault_daily & (1 << 7)) >> 7) printf("\tFault 8\n");
		if ((load_fault_daily & (1 << 7)) >> 7) fprintf(fp,"Fault 8:");
        fprintf(fp,",");
	}
	
	alarm_daily=(data[41] << 16) + data[42];
	//printf("alarm_daily = Today's controller self-diagnostic alarms:\n");
	if (alarm_daily == 0) {
		//printf("\tNo alarms\n");
		fprintf(fp,"No alarms,");
	} else { /* XXX! these alarms look like they are the same, we should split this out into a function call */
		//if (alarm_daily & 1) printf("\tRTS open\n");
		if (alarm_daily & 1) fprintf(fp,"RTS open:");
		//if ((alarm_daily & (1 << 1)) >> 1) printf("\tRTS shorted\n");
		if ((alarm_daily & (1 << 1)) >> 1) fprintf(fp,"RTS shorted:");
		//if ((alarm_daily & (1 << 2)) >> 2) printf("\tRTS disconnected\n");
		if ((alarm_daily & (1 << 2)) >> 2) fprintf(fp,"RTS disconnected:");
		//if ((alarm_daily & (1 << 3)) >> 3) printf("\tThs open\n");
		if ((alarm_daily & (1 << 3)) >> 3) fprintf(fp,"Ths open:");
		//if ((alarm_daily & (1 << 4)) >> 4) printf("\tThs shorted\n");
		if ((alarm_daily & (1 << 4)) >> 4) fprintf(fp,"Ths shorted:");
		//if ((alarm_daily & (1 << 5)) >> 5) printf("\tSSMPPT hot\n");
		if ((alarm_daily & (1 << 5)) >> 5) fprintf(fp,"SSMPPT hot:");
		//if ((alarm_daily & (1 << 6)) >> 6) printf("\tCurrent limit\n");
		if ((alarm_daily & (1 << 6)) >> 6) fprintf(fp,"Current limit:");
		//if ((alarm_daily & (1 << 7)) >> 7) printf("\tCurrent offset\n");
		if ((alarm_daily & (1 << 7)) >> 7) fprintf(fp,"Current offset:");
		//if ((alarm_daily & (1 << 8)) >> 8) printf("\tUndefined\n");
		if ((alarm_daily & (1 << 8)) >> 8) fprintf(fp,"8 Undefined:");
		//if ((alarm_daily & (1 << 9)) >> 9) printf("\tUndefined\n");
		if ((alarm_daily & (1 << 9)) >> 9) fprintf(fp,"9 Undefined:");
		//if ((alarm_daily & (1 << 10)) >> 10) printf("\tUncalibrated\n");
		if ((alarm_daily & (1 << 10)) >> 10) fprintf(fp,"Uncalibrated:");
		//if ((alarm_daily & (1 << 11)) >> 11) printf("\tRTS miswire\n");
		if ((alarm_daily & (1 << 11)) >> 11) fprintf(fp,"RTS miswire:");
		//if ((alarm_daily & (1 << 12)) >> 12) printf("\tUndefined\n");
		if ((alarm_daily & (1 << 12)) >> 12) fprintf(fp,"12 Undefined:");
		//if ((alarm_daily & (1 << 13)) >> 13) printf("\tUndefined\n");
		if ((alarm_daily & (1 << 13)) >> 13) fprintf(fp,"13 Undefined:");
		//if ((alarm_daily & (1 << 14)) >> 14) printf("\tMiswire\n");
		if ((alarm_daily & (1 << 14)) >> 14) fprintf(fp,"Miswire:");
		//if ((alarm_daily & (1 << 15)) >> 15) printf("\tFET open\n");
		if ((alarm_daily & (1 << 15)) >> 15) fprintf(fp,"FET open:");
		//if ((alarm_daily & (1 << 16)) >> 16) printf("\tP12\n");
		if ((alarm_daily & (1 << 16)) >> 16) fprintf(fp,"P12:");
		//if ((alarm_daily & (1 << 17)) >> 17) printf("\tHigh Va current limit\n");
		if ((alarm_daily & (1 << 17)) >> 17) fprintf(fp,"High Va current limit:");
		//if ((alarm_daily & (1 << 18)) >> 18) printf("\tAlarm 19\n");
		if ((alarm_daily & (1 << 18)) >> 18) fprintf(fp,"Alarm 19:");
		//if ((alarm_daily & (1 << 19)) >> 19) printf("\tAlarm 20\n");
		if ((alarm_daily & (1 << 19)) >> 19) fprintf(fp,"Alarm 20:");
		//if ((alarm_daily & (1 << 20)) >> 20) printf("\tAlarm 21\n");
		if ((alarm_daily & (1 << 20)) >> 20) fprintf(fp,"Alarm 21:");
		//if ((alarm_daily & (1 << 21)) >> 21) printf("\tAlarm 22\n");
		if ((alarm_daily & (1 << 21)) >> 21) fprintf(fp,"Alarm 22:");
		//if ((alarm_daily & (1 << 22)) >> 22) printf("\tAlarm 23\n");
		if ((alarm_daily & (1 << 22)) >> 22) fprintf(fp,"Alarm 23:");
		//if ((alarm_daily & (1 << 23)) >> 23) printf("\tAlarm 24\n");
		if ((alarm_daily & (1 << 23)) >> 23) fprintf(fp,"Alarm 24");
        fprintf(fp,",");
	}
	
	vb_min=data[43]*100.0/32768.0;
	//printf("vb_min = %.2f V\n",vb_min);
	fprintf(fp,"%.2f V,",vb_min);
	
	vb_max=data[44]*100.0/32768.0;
	//printf("vb_max = %.2f V\n",vb_max);
	fprintf(fp,"%.2f V",vb_max);
    fprintf(fp,"\n");
	
	return(0);
}
/*$Log: sunsaver.c,v $
 *Revision 1.6  2011/06/21 00:52:13  wschaub
 *Open/close the file every time we write to it, this should allow logrotate to do its thing
 *correctly.
 *
 *Revision 1.5  2011/06/21 00:29:26  wschaub
 *move timestamp fprintf to after the part that checks if the modbus was read successfully or not.
 *this keeps us from fucking up the log file with empty records.
 *
 *Revision 1.4  2011/06/20 21:33:19  wschaub
 *Changed the interval to 15 minutes and redirected the debug printf to stderr
 *
 *Revision 1.3  2011/06/20 21:03:13  wschaub
 *fixed fprintf that added an extra comma
 *
 *Revision 1.2  2011/06/20 06:36:22  wschaub
 *modified to write to a CSV file instead of stdout.
 **/
@


1.6
log
@Open/close the file every time we write to it, this should allow logrotate to do its thing
correctly.
@
text
@d1 1
a1 1
//$Id: sunsaver.c,v 1.5 2011/06/21 00:29:26 wschaub Exp wschaub $
d125 1
a125 1
	fprintf(fp,"%d °C,",T_hs);
d129 1
a129 1
	fprintf(fp,"%d °C,",T_batt);
d133 1
a133 1
	fprintf(fp,"%d °C,",T_amb);
d137 1
a137 1
	fprintf(fp,"%d °C,",T_rts);
d648 4
@


1.5
log
@move timestamp fprintf to after the part that checks if the modbus was read successfully or not.
this keeps us from fucking up the log file with empty records.
@
text
@d1 1
a1 1
//$Id: sunsaver.c,v 1.4 2011/06/20 21:33:19 wschaub Exp wschaub $
a42 1
    fp = fopen(argv[1],"a");
a43 4
    if(fp == NULL) {
        perror(argv[1]);
        exit(1);
    }
d46 5
d53 1
d648 4
@


1.4
log
@Changed the interval to 15 minutes and redirected the debug printf to stderr
@
text
@d1 1
a1 1
//$Id: sunsaver.c,v 1.3 2011/06/20 21:03:13 wschaub Exp wschaub $
a75 3
    timestamp = time(NULL);
    fprintf(fp,"%lu,",timestamp);//write timestamp field.
    fprintf(stderr,"%lu\n",timestamp);
d94 4
d647 3
@


1.3
log
@fixed fprintf that added an extra comma
@
text
@d1 1
a1 1
//$Id: sunsaver.c,v 1.2 2011/06/20 06:36:22 wschaub Exp wschaub $
d33 1
a33 1
#define INTERVAL 5 /* interval in seconds to poll the sunsaver for data */
a50 1
        sleep(INTERVAL);
d53 1
d78 1
a78 1
    printf("%lu\n",timestamp);
d646 3
@


1.2
log
@modified to write to a CSV file instead of stdout.
@
text
@d1 1
a1 1
//$Id$
d420 1
a420 1
			fprintf(fp,"led_state = %d ABSORPTION (GREEN BLINK, 1HZ),",led_state);
d645 4
a648 1
/*$Log$*/
@


1.1
log
@Initial revision
@
text
@d1 1
d23 1
a23 1

d28 1
d32 2
d35 2
a36 1
int main(void)
d38 23
d76 3
d84 2
a85 2
		printf("ERROR Connection failed\n");
		exit(1);
d91 2
a92 2
        printf("ERROR Failed to read registers\n");
        exit(1);
d99 1
a99 1
	printf("RAM Registers\n\n");
d102 2
a103 1
	printf("adc_vb_f = %.2f V\n",adc_vb_f);
d106 2
a107 1
	printf("adc_va_f = %.2f V\n",adc_va_f);
d110 2
a111 1
	printf("adc_vl_f = %.2f V\n",adc_vl_f);
d114 2
a115 1
	printf("adc_ic_f = %.2f A\n",adc_ic_f);
d118 2
a119 1
	printf("adc_il_f = %.2f A\n",adc_il_f);
d122 2
a123 1
	printf("T_hs = %d °C\n",T_hs);
d126 2
a127 1
	printf("T_batt = %d °C\n",T_batt);
d130 2
a131 1
	printf("T_amb = %d °C\n",T_amb);
d134 2
a135 1
	printf("T_rts = %d °C\n",T_rts);
d140 2
a141 1
			printf("charge_state = %d START\n",charge_state);
d144 2
a145 1
			printf("charge_state = %d NIGHT_CHECK\n",charge_state);
d148 2
a149 1
			printf("charge_state = %d DISCONNECT\n",charge_state);
d152 2
a153 1
			printf("charge_state = %d NIGHT\n",charge_state);
d156 2
a157 1
			printf("charge_state = %d FAULT\n",charge_state);
d160 2
a161 1
			printf("charge_state = %d BULK_CHARGE\n",charge_state);
d164 2
a165 1
			printf("charge_state = %d ABSORPTION\n",charge_state);
d168 2
a169 1
			printf("charge_state = %d FLOAT\n",charge_state);
d172 2
a173 1
			printf("charge_state = %d EQUALIZE\n",charge_state);
d175 1
d179 1
a179 1
	printf("array_fault = Solar input self-diagnostic faults:\n");
d181 2
a182 1
		printf("\tNo faults\n");
d184 33
a216 16
		if (array_fault & 1) printf("\tOvercurrent\n");
		if ((array_fault & (1 << 1)) >> 1) printf("\tFETs shorted\n");
		if ((array_fault & (1 << 2)) >> 2) printf("\tSoftware bug\n");
		if ((array_fault & (1 << 3)) >> 3) printf("\tBattery HVD\n");
		if ((array_fault & (1 << 4)) >> 4) printf("\tArray HVD\n");
		if ((array_fault & (1 << 5)) >> 5) printf("\tEEPROM setting edit (reset required)\n");
		if ((array_fault & (1 << 6)) >> 6) printf("\tRTS shorted\n");
		if ((array_fault & (1 << 7)) >> 7) printf("\tRTS was valid, now disconnected\n");
		if ((array_fault & (1 << 8)) >> 8) printf("\tLocal temperature sensor failed\n");
		if ((array_fault & (1 << 9)) >> 9) printf("\tFault 10\n");
		if ((array_fault & (1 << 10)) >> 10) printf("\tFault 11\n");
		if ((array_fault & (1 << 11)) >> 11) printf("\tFault 12\n");
		if ((array_fault & (1 << 12)) >> 12) printf("\tFault 13\n");
		if ((array_fault & (1 << 13)) >> 13) printf("\tFault 14\n");
		if ((array_fault & (1 << 14)) >> 14) printf("\tFault 15\n");
		if ((array_fault & (1 << 15)) >> 15) printf("\tFault 16\n");
d220 2
a221 1
	printf("Vb_f = %.2f V\n",Vb_f);
d224 2
a225 1
	printf("Vb_ref = %.2f V\n",Vb_ref);
d228 2
a229 1
	printf("Ahc_r = %.2f Ah\n",Ahc_r);
d232 2
a233 1
	printf("Ahc_t = %.2f Ah\n",Ahc_t);
d236 2
a237 1
	printf("kWhc = %.2f kWh\n",kWhc);
d242 2
a243 1
			printf("load_state = %d START\n",load_state);
d246 2
a247 1
			printf("load_state = %d LOAD_ON\n",load_state);
d250 2
a251 1
			printf("load_state = %d LVD_WARNING\n",load_state);
d254 2
a255 1
			printf("load_state = %d LVD\n",load_state);
d258 2
a259 1
			printf("load_state = %d FAULT\n",load_state);
d262 2
a263 1
			printf("load_state = %d DISCONNECT\n",load_state);
d268 1
a268 1
	printf("load_fault = Load output self-diagnostic faults:\n");
d270 2
a271 1
		printf("\tNo faults\n");
d273 17
a289 8
		if (load_fault & 1) printf("\tExternal short circuit\n");
		if ((load_fault & (1 << 1)) >> 1) printf("\tOvercurrent\n");
		if ((load_fault & (1 << 2)) >> 2) printf("\tFETs shorted\n");
		if ((load_fault & (1 << 3)) >> 3) printf("\tSoftware bug\n");
		if ((load_fault & (1 << 4)) >> 4) printf("\tHVD\n");
		if ((load_fault & (1 << 5)) >> 5) printf("\tHeatsink over-temperature\n");
		if ((load_fault & (1 << 6)) >> 6) printf("\tEEPROM setting edit (reset required)\n");
		if ((load_fault & (1 << 7)) >> 7) printf("\tFault 8\n");
d293 2
a294 1
	printf("V_lvd = %.2f V\n",V_lvd);
d297 2
a298 1
	printf("Ahl_r = %.2f Ah\n",Ahl_r);
d301 2
a302 1
	printf("Ahl_t = %.2f Ah\n",Ahl_t);
d305 2
a306 1
	printf("hourmeter = %d h\n",hourmeter);
d309 1
a309 1
	printf("alarm = Controller self-diagnostic alarms:\n");
d311 2
a312 1
		printf("\tNo alarms\n");
d314 49
a362 24
		if (alarm & 1) printf("\tRTS open\n");
		if ((alarm & (1 << 1)) >> 1) printf("\tRTS shorted\n");
		if ((alarm & (1 << 2)) >> 2) printf("\tRTS disconnected\n");
		if ((alarm & (1 << 3)) >> 3) printf("\tThs open\n");
		if ((alarm & (1 << 4)) >> 4) printf("\tThs shorted\n");
		if ((alarm & (1 << 5)) >> 5) printf("\tSSMPPT hot\n");
		if ((alarm & (1 << 6)) >> 6) printf("\tCurrent limit\n");
		if ((alarm & (1 << 7)) >> 7) printf("\tCurrent offset\n");
		if ((alarm & (1 << 8)) >> 8) printf("\tUndefined\n");
		if ((alarm & (1 << 9)) >> 9) printf("\tUndefined\n");
		if ((alarm & (1 << 10)) >> 10) printf("\tUncalibrated\n");
		if ((alarm & (1 << 11)) >> 11) printf("\tRTS miswire\n");
		if ((alarm & (1 << 12)) >> 12) printf("\tUndefined\n");
		if ((alarm & (1 << 13)) >> 13) printf("\tUndefined\n");
		if ((alarm & (1 << 14)) >> 14) printf("\tMiswire\n");
		if ((alarm & (1 << 15)) >> 15) printf("\tFET open\n");
		if ((alarm & (1 << 16)) >> 16) printf("\tP12\n");
		if ((alarm & (1 << 17)) >> 17) printf("\tHigh Va current limit\n");
		if ((alarm & (1 << 18)) >> 18) printf("\tAlarm 19\n");
		if ((alarm & (1 << 19)) >> 19) printf("\tAlarm 20\n");
		if ((alarm & (1 << 20)) >> 20) printf("\tAlarm 21\n");
		if ((alarm & (1 << 21)) >> 21) printf("\tAlarm 22\n");
		if ((alarm & (1 << 22)) >> 22) printf("\tAlarm 23\n");
		if ((alarm & (1 << 23)) >> 23) printf("\tAlarm 24\n");
d366 1
a366 1
	printf("dip_switch = DIP switch settings:\n");
d368 2
a369 1
		printf("\tSwitch 1 ON - Battery Type: Gel or AGM\n");
d371 2
a372 1
		printf("\tSwitch 1 OFF - Battery Type: Sealed or Flooded\n");
d375 2
a376 1
		printf("\tSwitch 2 ON - LVD = 11.00 V, LVR = 12.10 V or custom load settings\n");
d378 2
a379 1
		printf("\tSwitch 2 OFF - LVD = 11.50 V, LVR = 12.60 V\n");
d382 2
a383 1
		printf("\tSwitch 3 ON - Auto-Equalize On\n");
d385 2
a386 1
		printf("\tSwitch 3 OFF - Auto-Equalize Off\n");
d389 2
a390 1
		printf("\tSwitch 4 ON - MODBUS Protocol\n");
d392 2
a393 1
		printf("\tSwitch 4 OFF - Meterbus Protocol\n");
d399 2
a400 1
			printf("led_state = %d LED_START\n",led_state);
d403 2
a404 1
			printf("led_state = %d LED_START2\n",led_state);
d407 2
a408 1
			printf("led_state = %d LED_BRANCH\n",led_state);
d411 2
a412 1
			printf("led_state = %d EQUALIZE (FAST GREEN BLINK)\n",led_state);
d415 2
a416 1
			printf("led_state = %d FLOAT (SLOW GREEN BLINK)\n",led_state);
d419 2
a420 1
			printf("led_state = %d ABSORPTION (GREEN BLINK, 1HZ)\n",led_state);
d423 2
a424 1
			printf("led_state = %d GREEN_LED\n",led_state);
d427 2
a428 1
			printf("led_state = %d UNDEFINED\n",led_state);
d431 2
a432 1
			printf("led_state = %d YELLOW_LED\n",led_state);
d435 1
a435 1
			printf("led_state = %d UNDEFINED\n",led_state);
d438 2
a439 1
			printf("led_state = %d BLINK_RED_LED\n",led_state);
d442 2
a443 1
			printf("led_state = %d RED_LED\n",led_state);
d446 2
a447 1
			printf("led_state = %d R-Y-G ERROR\n",led_state);
d450 2
a451 1
			printf("led_state = %d R/Y-G ERROR\n",led_state);
d454 2
a455 1
			printf("led_state = %d R/G-Y ERROR\n",led_state);
d458 2
a459 1
			printf("led_state = %d R-Y ERROR (HTD)\n",led_state);
d462 2
a463 1
			printf("led_state = %d R-G ERROR (HVD)\n",led_state);
d466 2
a467 1
			printf("led_state = %d R/Y-G/Y ERROR\n",led_state);
d470 2
a471 1
			printf("led_state = %d G/Y/R ERROR\n",led_state);
d474 2
a475 1
			printf("led_state = %d G/Y/R x 2\n",led_state);
d480 2
a481 1
	printf("Power_out = %.2f W\n",Power_out);
d484 2
a485 1
	printf("Sweep_Vmp = %.2f V\n",Sweep_Vmp);
d488 2
a489 1
	printf("Sweep_Pmax = %.2f W\n",Sweep_Pmax);
d492 2
a493 1
	printf("Sweep_Voc = %.2f V\n",Sweep_Voc);
d496 2
a497 1
	printf("Vb_min_daily = %.2f V\n",Vb_min_daily);
d500 2
a501 1
	printf("Vb_max_daily = %.2f V\n",Vb_max_daily);
d504 2
a505 1
	printf("Ahc_daily = %.2f Ah\n",Ahc_daily);
d508 2
a509 1
	printf("Ahl_daily = %.2f Ah\n",Ahl_daily);
d512 1
a512 1
	printf("array_fault_daily = Today's solar input self-diagnostic faults:\n");
d514 2
a515 1
		printf("\tNo faults\n");
d517 33
a549 16
		if (array_fault_daily & 1) printf("\tOvercurrent\n");
		if ((array_fault_daily & (1 << 1)) >> 1) printf("\tFETs shorted\n");
		if ((array_fault_daily & (1 << 2)) >> 2) printf("\tSoftware bug\n");
		if ((array_fault_daily & (1 << 3)) >> 3) printf("\tBattery HVD\n");
		if ((array_fault_daily & (1 << 4)) >> 4) printf("\tArray HVD\n");
		if ((array_fault_daily & (1 << 5)) >> 5) printf("\tEEPROM setting edit (reset required)\n");
		if ((array_fault_daily & (1 << 6)) >> 6) printf("\tRTS shorted\n");
		if ((array_fault_daily & (1 << 7)) >> 7) printf("\tRTS was valid, now disconnected\n");
		if ((array_fault_daily & (1 << 8)) >> 8) printf("\tLocal temperature sensor failed\n");
		if ((array_fault_daily & (1 << 9)) >> 9) printf("\tFault 10\n");
		if ((array_fault_daily & (1 << 10)) >> 10) printf("\tFault 11\n");
		if ((array_fault_daily & (1 << 11)) >> 11) printf("\tFault 12\n");
		if ((array_fault_daily & (1 << 12)) >> 12) printf("\tFault 13\n");
		if ((array_fault_daily & (1 << 13)) >> 13) printf("\tFault 14\n");
		if ((array_fault_daily & (1 << 14)) >> 14) printf("\tFault 15\n");
		if ((array_fault_daily & (1 << 15)) >> 15) printf("\tFault 16\n");
d553 1
a553 1
	printf("load_fault_daily = Today's load output self-diagnostic faults:\n");
d555 2
a556 1
		printf("\tNo faults\n");
d558 17
a574 8
		if (load_fault_daily & 1) printf("\tExternal short circuit\n");
		if ((load_fault_daily & (1 << 1)) >> 1) printf("\tOvercurrent\n");
		if ((load_fault_daily & (1 << 2)) >> 2) printf("\tFETs shorted\n");
		if ((load_fault_daily & (1 << 3)) >> 3) printf("\tSoftware bug\n");
		if ((load_fault_daily & (1 << 4)) >> 4) printf("\tHVD\n");
		if ((load_fault_daily & (1 << 5)) >> 5) printf("\tHeatsink over-temperature\n");
		if ((load_fault_daily & (1 << 6)) >> 6) printf("\tEEPROM setting edit (reset required)\n");
		if ((load_fault_daily & (1 << 7)) >> 7) printf("\tFault 8\n");
d578 1
a578 1
	printf("alarm_daily = Today's controller self-diagnostic alarms:\n");
d580 52
a631 26
		printf("\tNo alarms\n");
	} else {
		if (alarm_daily & 1) printf("\tRTS open\n");
		if ((alarm_daily & (1 << 1)) >> 1) printf("\tRTS shorted\n");
		if ((alarm_daily & (1 << 2)) >> 2) printf("\tRTS disconnected\n");
		if ((alarm_daily & (1 << 3)) >> 3) printf("\tThs open\n");
		if ((alarm_daily & (1 << 4)) >> 4) printf("\tThs shorted\n");
		if ((alarm_daily & (1 << 5)) >> 5) printf("\tSSMPPT hot\n");
		if ((alarm_daily & (1 << 6)) >> 6) printf("\tCurrent limit\n");
		if ((alarm_daily & (1 << 7)) >> 7) printf("\tCurrent offset\n");
		if ((alarm_daily & (1 << 8)) >> 8) printf("\tUndefined\n");
		if ((alarm_daily & (1 << 9)) >> 9) printf("\tUndefined\n");
		if ((alarm_daily & (1 << 10)) >> 10) printf("\tUncalibrated\n");
		if ((alarm_daily & (1 << 11)) >> 11) printf("\tRTS miswire\n");
		if ((alarm_daily & (1 << 12)) >> 12) printf("\tUndefined\n");
		if ((alarm_daily & (1 << 13)) >> 13) printf("\tUndefined\n");
		if ((alarm_daily & (1 << 14)) >> 14) printf("\tMiswire\n");
		if ((alarm_daily & (1 << 15)) >> 15) printf("\tFET open\n");
		if ((alarm_daily & (1 << 16)) >> 16) printf("\tP12\n");
		if ((alarm_daily & (1 << 17)) >> 17) printf("\tHigh Va current limit\n");
		if ((alarm_daily & (1 << 18)) >> 18) printf("\tAlarm 19\n");
		if ((alarm_daily & (1 << 19)) >> 19) printf("\tAlarm 20\n");
		if ((alarm_daily & (1 << 20)) >> 20) printf("\tAlarm 21\n");
		if ((alarm_daily & (1 << 21)) >> 21) printf("\tAlarm 22\n");
		if ((alarm_daily & (1 << 22)) >> 22) printf("\tAlarm 23\n");
		if ((alarm_daily & (1 << 23)) >> 23) printf("\tAlarm 24\n");
d635 2
a636 1
	printf("vb_min = %.2f V\n",vb_min);
d639 3
a641 1
	printf("vb_max = %.2f V\n",vb_max);
d645 1
a645 1

@
